```
server {
	listen 443 ssl http2;
	server_name secure.example.com;
	# 認証局によって署名されたサーバ証明書
	ssl_certificate /etc/nginx/ssl/cert.pem;
	# 秘密鍵のファイルパス
	ssl_certificate_key /etc/nginx/ssl/cert.key;
	# 秘密鍵を扱うためのパスフレーズ記載ファイル
	ssl_password_file /etc/nginx/ssl/cert.password;
	# セッションキャッシュ
	# ssl_session_cache オプション:キャッシュ名:キャッシュサイズ
	ssl_session_cache shared:SSL:10m;
	# セッションキャッシュのタイムアウト
  ssl_session_timeout 10m;
  # セッションチケット
  ssl_session_ticket on;
  # セッションチケットの暗号鍵
  ssl_session_ticket_key etc/nginx/ssl/ticket.key;
}
```

nginxではTLSを実現するためにOpenSSLを使用している

使用しているOpenSSLのバージョンを確認

```
> nginx -V
built with OpenSSL 1.0.2d 9 Jul 2015
```

## HTTP/2

HTTPの新バージョンとして策定されたプロトコル

Googleによって開発されたSPDYをベースにしていて、通信路の多重化、ヘッダ圧縮、パイプライニングなどの技術によりTTFBを削減し、Webページを高速かつ効率よく転送することが目的

nginxでHTTP/2を有効化するには `ngx_http_v2_module` が必要で、デフォルトで組み込まれていない。

なのでビルド時に `--with-http_v2_module` を指定する必要がある。

## **ssl_session_cache**

TLSハンドシェイクで余計なやりとりが発生したりCPU処理が必要だったりと、オーバーヘッドがある。

前回使用したTLSセッションを保存しセッションを再開できれば削減できそう。

| パラメータ | 説明 |
| --- | --- |
| off | セッションの再利用を明示的に禁止 |
| none | クライアントにはセッションの再利用を明示的には禁止しないが、実際は利用不可 |
| builtin | OpenSSL組み込みを利用
一つのワーカープロセスのみが利用可能 |
| shared | すべてのワーカープロセスで共有
「shared:名前:サイズ」の形式で記述 |

### TLSハンドシェイク

導入時、2つのサーバー間で、互いを認め、検証し、暗号コードを設定し、セッションキーに合意するためにメッセージを交換する安全な通信を示す。

TLSのハンドシェイクプロセスは、最初の「Hello」から始まり、クライアントとサーバーが安全な接続を介して会話できる段階まで続く。

## **ssl_session_ticket**

セッションキャッシュはセッション情報を共有メモリにキャッシュするため、複数台サーバでセッション情報を共有できない。

これを解決するのがセッションチケット。

セッション情報を暗号化し、チケットとしてクライアントに送信。クライアントはこのチケットをサーバーに送信することで前回のTLSセッションを再開できる。

### 使用の検討

攻撃者がセッションチケット鍵を手にいれると、そのセッション全ての解読が可能になってしまう。そのため、PFSを満たすためにはセッションチケット鍵を短い期間で再生成する必要がある。

しかしnginxにはチケット鍵を自動的に再生成する機能が提供されていないので、自分で定期的に再生成する必要がある。

セッションキャッシュのみで問題なければセッションチケットを無効にすることも検討の余地あり。